<!-- manage_return.html -->
{% extends 'base.html' %}
{% load custom_filters %}

{% block content %}
<style>
    table {
        border-collapse: separate; /* Nécessaire pour que border-radius fonctionne */
        border-spacing: 0;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 10px; /* Ajustez la valeur pour changer le rayon des coins */
        overflow: hidden; /* Pour que le contenu respecte les coins arrondis */
    }
    
    thead th {
        background-color: #f2f2f2;
        color: #333;
        padding: 12px;
        text-align: left;
    }
    
    tbody td {
        padding: 12px;
        border-bottom: 1px solid #ddd;
    }
    
    tbody tr:last-child td {
        border-bottom: none; /* Retire la bordure de la dernière ligne */
    }
</style>

<div class="container mt-5">
    <h2>Gérer les Retours pour la transaction {{ transaction_pk }}</h2>
    <strong>Client :</strong>
    <span>
        {% if transaction.client %}
            {{ transaction.client.nom }} {{ transaction.client.prenom }}
        {% else %}
            Anonyme
        {% endif %}
    </span>
    <p><strong>Points de fidélité à retirer pour ce retour :</strong> {{ points_to_remove }}{{ transaction.points_gagnes }} points</p>
    <form method="post">
        {% csrf_token %}
        <div class="card-body">
            <table class="table table-striped">
                <thead class="table-dark"> 
                    <tr>
                        <th>Article</th>
                        <th>Quantité achetée</th>
                        <th>Quantité à retourner</th>
                        <th>Prix unitaire (€)</th>
                        <th>Total (€)</th>
                        <th>Promotion</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>{{ item.product.nom_article }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>
                            {% if item.promotion_applied %}
                                <span class="text-danger">Non retournable (promotion appliquée)</span>
                            {% else %}
                            <input type="number" name="quantity_returned_{{ item.id }}" min="0" max="{{ item.quantity|subtract:item.returned_quantity }}" class="form-control" value="0">
                            {% endif %}
                        </td>
                        <td>{{ item.price|floatformat:2 }} €</td>
                        <td>{{ item.price|floatformat:2 }} € x {{ item.quantity }} = {{ item.price|mul:item.quantity|floatformat:2 }} €</td>
                        <td>
                            {% if item.promotion_applied %}
                                <span class="badge bg-danger">Oui</span>
                            {% else %}
                                <span class="badge bg-success">Non</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button type="submit" class="btn btn-success">Valider les Retours</button>
        </div>
    </form>
    <a href="{% url 'sales_history' %}" class="btn btn-primary mt-3">Retour à l'Historique des ventes</a>
</div>
{% endblock %}
